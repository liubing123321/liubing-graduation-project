<%@ page import="com.google.common.collect.Lists" %>
<%@ page import="com.wormpex.api.json.JsonUtil" %>
<%@ page import="com.wormpex.bach.affair.core.api.model.transfer.TransferOrder" %>
<%@ page import="com.wormpex.bach.affair.core.api.remote.TransferRemote" %>
<%@ page import="com.wormpex.bach.affair.core.api.util.order.TransferOrderConverter" %>
<%@ page import="com.wormpex.bach.affair.man.common.OpLogs" %>
<%@ page import="com.wormpex.bach.affair.man.common.constant.ManConstant" %>
<%@ page import="com.wormpex.bach.affair.man.common.constant.QueryPathConstant" %>
<%@ page import="com.wormpex.bach.affair.man.model.vo.pda.AffairUserContext" %>
<%@ page import="com.wormpex.bach.affair.man.model.vo.pda.AffairUserInfo" %>
<%@ page import="com.wormpex.bach.affair.man.service.adapter.ShopService" %>
<%@ page import="com.wormpex.bach.affair.man.service.particular.OrderStoreRemoteWrapper" %>
<%@ page import="com.wormpex.inf.order.store.api.expression.Expression" %>
<%@ page import="com.wormpex.inf.order.store.api.expression.ExpressionBuilder" %>
<%@ page import="com.wormpex.inf.order.store.api.model.Order" %>
<%@ page import="com.wormpex.inf.order.store.api.model.VersionData" %>
<%@ page import="com.wormpex.inf.order.store.api.query.Query" %>
<%@ page import="com.wormpex.inf.order.store.api.type.Ordering" %>
<%@ page import="org.slf4j.Logger" %>
<%@ page import="org.slf4j.LoggerFactory" %>
<%@ page import="org.springframework.context.ApplicationContext" %>
<%@ page import="org.springframework.web.context.support.WebApplicationContextUtils" %>
<%@ page import="java.io.PrintWriter" %>
<%@ page import="java.util.Arrays" %>
<%@ page import="java.util.List" %>

<%@ page contentType="text/html;charset=UTF-8" language="java" %>
<html>
<head>
    <title>queryorder</title>
</head>
<body>

<%
    PrintWriter outPrint = response.getWriter();
    try {
        Logger logger = LoggerFactory.getLogger(OrderStoreRemoteWrapper.class);

        AffairUserInfo affairUserInfo = new AffairUserInfo();

        affairUserInfo.setUserName("system_fix");
        affairUserInfo.setUserRole("");
        affairUserInfo.setMobile("");
        affairUserInfo.setTerminal("");
        affairUserInfo.setUserId("system_fix");
        affairUserInfo.setUserIp("");
        affairUserInfo.setShopInfo(null);
        AffairUserContext.setUserInfo(affairUserInfo);

        ServletContext context = request.getSession().getServletContext();
        ApplicationContext ctx = WebApplicationContextUtils.getWebApplicationContext(context);

        OrderStoreRemoteWrapper orderStoreRemoteWrapper = ctx.getBean(OrderStoreRemoteWrapper.class);
        ShopService shopService = ctx.getBean(ShopService.class);
        TransferRemote transferRemote = ctx.getBean(TransferRemote.class);

        String orderIds = "49023538935068,49023861695409,49023838209021,49023811512570";
        List<String> orderIdList = Arrays.asList(orderIds.split(","));

        List<String> orderIdListNew = Lists.newArrayList();
        for (String orderId : orderIdList) {
            orderIdListNew.add(orderId.trim());
        }

        List<List<String>> orderIdBatch = Lists.partition(orderIdListNew, 200);

        for (List<String> idBatch : orderIdBatch) {

            logger.info("idBatch:{}", JsonUtil.toJson(idBatch));

            String[] orderIdArr = org.unidal.helper.Lists.toArray(String.class, idBatch);

            Expression inOrder = ExpressionBuilder.in(ManConstant.TransferQueryPathConstant.orderIdField, orderIdArr);
            Query query = Query.newQuery(0, 200).where(ExpressionBuilder.and(inOrder))
                    .orderBy(QueryPathConstant.TransferPath.createDate, Ordering.ASC)
                    .orderBy(QueryPathConstant.TransferPath.orderId, Ordering.ASC);

            logger.info("query order jsp , query:{}", JsonUtil.toJson(query));

            Iterable<List<VersionData<Order>>> storeResult = orderStoreRemoteWrapper.queryAllOrder(ManConstant.StoreAppId.TRANSFER, query);

            logger.info("query order jsp , vesiondata.:{}", JsonUtil.toJson(storeResult));

            for (List<VersionData<Order>> versionDatas : storeResult) {
                logger.info("query order jsp , vesiondata.size:{}", versionDatas.size());
                for (VersionData<Order> versionData : versionDatas) {
                    TransferOrder transferOrder = TransferOrderConverter.toBizData(versionData);

                    logger.info("开始更新 {}", transferOrder.getOrderId());
                    transferOrder.getMain().setShopTo(shopService.dealWithShopType(transferOrder.getMain().getShopTo()));
                    transferOrder.getMain().setShopFrom(shopService.dealWithShopType(transferOrder.getMain().getShopFrom()));

                    transferRemote.update(transferOrder, OpLogs.simpleOrderLog("system_fix","更新shop 信息"));
                    logger.info("更新成功 {}", JsonUtil.toJson(transferOrder));
                }
            }
        }

    } catch (Exception e) {
        outPrint.println("An exception occurred: " + e.getMessage());
        outPrint.println();
        for (StackTraceElement k : e.getStackTrace())
            outPrint.println(k);
    } finally {
        outPrint.close();
    }
%>
</body>
</html>



备份：
49023538935068,49023861695409,49023838209021,49023811512570,49024553472811,49024863217778,49024837004162,49024942440249,49024927376349,49024937053319,49025148639915,49025103547876,49025151697895,49025109513770,49025104718237,49025160976034,49025154462640,49025136459058,49025128316834,49025134806233,49025123832213,49025143169680,49025135179186,49025153381154,49025139122936,49025120310946,49025245264760,49025235041944,49025259797668,49025257579668,49025263056280,49025234238156,49025559179035,49025529934387,49025556173057,49025645022674,49025653486347,49025742279154,49025712598310,49025728291764,49025830806879,49025849419458,49025852947939,49025841855039,49025938344797,49025929775002,49025945502102,49026414411129,49026430595948,49026863134145,49026801675216,49026815322919,49026943992894,49026964995922,49026908817359,49027028505083,49027026369896,49027016482642,49027232102209,49027227525961,49027219347084,49027227921988,49027222739947,49027235487713,49027210109730,49027320128455,49027342128169,49027366944018,49027358865958,49027305681280,49027304396276,49027343488025,49027319611756,49027338378106,49027358651793,49027457316453,49027428349474,49027460284265,49027439938450,49027449331762,49027445622576,49027445990769,49027616047886,49027610147172,49027643850486,49027758192356,49027713490317,49027725219010,49027739523191,49027749591981,49027727821859,49027713609560,49027747811300,49027765870522,49027816479972,49027808260996,49027825525513,49027936871228,49027948542970,49027923100908,49028010339722,49028042023192,49028026043795,49028156844668,49028130777581,49028350737761,49028356770560,49028320940054,49028460017303,49028562922731,49028555645690,49028559383145,49028546730047,49028523294861,49028531226298,49028549466649,49028554010252,49028625639883,49028667078694,49028655194972,49028634100497,49028617646878,49028635248736,49028652340219,49028635311001,49028616755475,49028629938337,49028760362842,49028752190409,49028743844737,49028743847844,49028736653009,49028716439558,49028761833257,49028730115028,49028732114377,49028730660415,49028717279556,49028751734310,49028744613285,49028720372417,49028803210342,49028830268877,49028903313797,49029051290635,49029634234636,49029747522847,49029802594570,49029855737459,49029961776016,49029924873227,49029958910512,49029910124993,49029939113242,49029932276777,49029935835303,49029953478736,49029953497535,49029957470958,49029929912435,49030051601036,49030027926103,49030039691823,49030006418042,49030002590155,49030048953309,49030033997243,49030044059141,49030007610427,49030007388792,49030049786498,49030012429584,49030002682870,49030003778196,49030050007591,49030025625695,49030053705763,49030021247918,49030009762466,49030011233498,49030035715021,49030041153900,49030065078558,49030062628527,49030047674157,49030043488396,49030062416884,49030043704485,49030028441762,49030017921263,49030001051879,49030015112128,49030001922356,49030023052110,49030049489569,49030004303065,49030040320130,49030045627261,49030022335997,49030034423007,49030058562650,49030056196974,49030115056671,49030150919378,49030146422452,49030163336995,49030130372692,49030127319155,49030137227761,49030200904902,49030221548618,49030243337230,49030317351524,49030351450729,49030367063218,49030329520133,49030346818877,49030340768167,49030361745687,49030357386591,49030454676170,49030407230670,49030419806611,49030447315023,49030400779839,49030423615892,49030462236726,49030433792287,49030440272242,49030461092479,49030461215794,49030422481846,49030406880002,49030400306885,49030430309247,49030410509305,49030410593642,49030418808474,49030539418378,49030524700044,49030505190598,49030539973785,49030527833591,49030550227121,49030509467254,49030503513247,49030525900471,49030525557786,49030641368094,49030658777681,49030665627458,49030640563748,49030609310767,49030665561162,49030659577395,49030600074005,49030749590210,49030702055671,49030738895684,49030744437849,49030736065033,49030730289570,49030716256196,49030747583651,49030743721678,49030716194558,49030708993724,49030743640754,49030705389900,49030721304086,49030756464554,49030735229985,49030709631951,49030701937742,49030728318476,49030724342485,49030710727878,49030747218891,49030706105650,49030703283738,49030715304766,49030702378407,49030764885483,49030762335905,49030711278105,49030708917523,49030709752463,49030708271369,49030761405447,49030718969596,49030754505075,49030763229429,49030833111163,49030821609439,49030817475381,49030810478374,49030849420327,49030826917321,49030837822067,49030831759702,49030838345396,49030811962769,49030848127683,49030831105705,49030815119062,49030846393205,49030830489805,49030817464189,49030820465816,49030844241521,49030866452691,49030829135558,49030857380568,49030801925619,49030805939768,49030838073881,49030854829167,49030840761445,49030823484390,49030833238011,49030825195557,49030813689745,49030842087715,49030852247660,49030837603140,49030852463719,49030849999005,49030823120911,49030846100140,49030800797456,49030855780407,49030809735889,49030806604895,49030819973104,49030918273173,49030941346595,49030920820675,49030964370900,49030939898447,49030901131369,49030944278338,49030919722705,49030902960578,49030929829049,49030936725932,49030923098539,49030939446746,49031037490790,49031066292041,49031034662284,49031003781254,49031052645311,49031032837355,49031027954304,49031065303258,49031028138556,49031024131623,49031009330550,49031014788156,49031021019088,49031005484477,49031104636341,49031123839202,49031140108789,49031162112224,49031154212006,49031135370106,49031160284101,49031152192797,49031146576161,49031124727250,49031106045975,49031126393710,49031114635449,49031136580560,49031166326762,49031163643530,49031130148640,49031152706275,49031100820278,49031132612922,49031103379243,49031114314133,49031262503282,49031222671686,49031251161400,49031211939231,49031244877484,49031211286596,49031252609709,49031207047583,49031228376075,49031214783646,49031260899982,49031249561248,49031243823373,49031265592048,49031220690296,49031249414456,49031236097498,49031200274471,49031261628739,49031221320800,49031223280389,49031252874118,49031262897400,49031216007918,49031238285754,49031236325599,49031201751797,49031246098584,49031204421780,49031212585128,49031263363333,49031248936642,49031232503189,49031237298370,49031261102779,49031210217925,49031202736039,49031257984146,49031220967903,49031212601807,49031224027331,49031213094668,49031263682241,49031224374858,49031262484827,49031238292702,49031215618637,49031240888163,49031233650878,49031232014891,49031229389555,49031366956631,49031323634203,49031312341299,49031328334874,49031360887692,49031348542124,49031326267896,49031338853546,49031315317083,49031331827119,49031307627363,49031361446899,49031345456180,49031331606384,49031365484013,49031304585493,49031360908471,49031355301683,49031352469073,49031355065489,49031340453822,49031328089683,49031342396148,49031313830917,49031337530736,49031318390791,49031307693646,49031320258799,49031352568423,49031356191546,49031362798818,49031365516507,49031357388359,49031314403436,49031309834601,49031335539509,49031324386112,49031366724890,49031308642818,49031347385664,49031355645125,49031311025602,49031324111127,49031302051310,49031337001357,49031359164434,49031355173324,49031312774298,49031343344445,49031303809257,49031308424813,49031342021940,49031321656712,49031355568092,49031335196529,49031317402760,49031335391006,49031363869870,49031340527120,49031346843775,49031352425520,49031314856528,49031337907919,49031352207917,49031351737531,49031347762986,49031325310245,49031348714626,49031308684379,49031312507607,49031334140671,49031324484980,49031312445172,49031353310311,49031350446698,49031332477174,49031315801104,49031328895221,49031357066175,49031346780040,49031327510557,49031414684884,49031405392989,49031429511093,49031434683709,49031448372328,49031465019304,49031436359117,49031430150380,49031466463230,49031432478659,49031420893890,49031415656357,49031432851632,49031461449951,49031447057946,49031453611297,49031438135238,49031413365569,49031404406169,49031418429233,49031415628373,49031402975579,49031466296199,49031409019057,49031463945377,49031445350547,49031436337025,49031448687743,49031429575510,49031406234428,49031420204968,49031425327008,49031463713283,49031449858561,49031413680675,49031445131021,49031457221920,49031415990864,49031415717056,49031441374382,49031435682243,49031436159777,49031461645388,49031400437104,49031430643874,49031416772129,49031427415632,49031461174112,49031411014963,49031430908907,49031431176867,49031423392154,49031443722102,49031448183282,


